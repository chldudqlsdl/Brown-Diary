# **19. Root ViewController Setup & Keeping User Logged In**

### SceneDelegate â†’ rootViewController ë°”ê¿”ì£¼ê¸°

```swift
window?.rootViewController = MainTabController()
```

### ì´ë¯¸ ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆë‹¤ë©´ SignOut í•´ì£¼ê³ 

```swift
func logUserOut() {
    do {
        try Auth.auth().signOut()
    } catch {
        print(error.localizedDescription)
    }
}
```

### ë¡œê·¸ì¸ì—¬ë¶€ ì²´í¬í•´ì„œ ê·¸ì— ë”°ë¼ ì—¬ëŸ¬ í™”ë©´ ë„ìš°ê¸° (currentUser - í˜„ì¬ ì‚¬ìš©ìê°€ ìˆëƒ?)

- `**DispatchQueue.main.async { code }` ì•ˆ í•´ì£¼ë©´ ì ìš©ì•ˆë¨! â†’ ì—ëŸ¬ë„ ì•ˆëœ¸â€¦**

```swift
func authenticateUserAndConfigureUI() {
    if Auth.auth().currentUser == nil {
        DispatchQueue.main.async {
            let nav = UINavigationController(rootViewController: LoginController())
            nav.modalPresentationStyle = .fullScreen
            self.present(nav, animated: true)
        }
    } else {
        configureViewControllers()
        configureUI()
    }
}
```

# **20. Logging A User In**

### ë¡œê·¸ì¸ ë¡œì§

```swift
struct AuthService {
    static let shared = AuthService()
    
    func logUserIn(withEmail email: String, withPassword password: String, completion: @escaping (AuthDataResult?, Error?) -> Void ) {
        Auth.auth().signIn(withEmail: email, password: password, completion: completion)
    }
}
```

### ë·°ì»¨íŠ¸ë¡¤ëŸ¬ì— ì—°ê²° + ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬

```swift
// LoginController

@objc func handleLogin() {
    guard let email = emailTextField.text else { return }
    guard let password = passwordTextField.text else { return }
    
    AuthService.shared.logUserIn(withEmail: email, withPassword: password) { result, error in
        if let error = error {
            print(error.localizedDescription)
            return
        }
        print("Logged in Sucessfully")
    }
}
```

### í•œë²ˆ ë¡œê·¸ì¸ì´ ë˜ë©´ mainTabController ì—ì„œ ë¶„ê¸°ë˜ì–´ì„œ LoginController ëŠ” ì•ˆ ëœ¬ë‹¤

# **21. Update UI After Authentication**

### Login ë˜ë©´ í™”ë©´ ë‚´ë¦¬ê¸°

```swift
dismiss(animated: true, completion: nil)

```

### But MainViewController ê°€ ë°‘ì— ê¹”ë ¤ìˆëŠ”ë°, Configure ê°€ ë˜ì–´ ìˆì§€ ì•ŠìŒ

- rootViewController ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì´ ë§¤ìš° ì‰¬ì›Œì§„ ë“¯â€¦?

```swift
guard let tab = self.view.window?.rootViewController as? MainTabController else { return }

tab.authenticateUserAndConfigureUI()
            
self.dismiss(animated: true, completion: nil)
```

### RegistrationController ì—ë„ ìœ„ ì½”ë“œë¥¼ ì ì–´ì£¼ë©´, íšŒì›ê°€ì… í›„ì—ë„ ë°”ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥

# 22. Fetch User Data From Firebase

### ìœ ì € ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” ë°©ë²•

- uid ë¥¼ key ë¡œ í•˜ëŠ” value ì¸ snapshot ì„ ë°›ì•„ì˜¨ë‹¤

```swift
struct UserService {
    static let shared = UserService()
    
    func fetchUser(){
        guard let uid = Auth.auth().currentUser?.uid else { return }
        
        REF_USERS.child(uid).observeSingleEvent(of: .value) { snapshot in
        
            guard let dictionary = snapshot.value as? [String: AnyObject] else { return }
            guard let username = dictionary["username"] as? String else { return }
            print(username)
        }
    }
}
```

# **23. Create Custom User Object (Model)**

### User Model ë§Œë“¤ê¸°

```swift
struct User {
    let uid: String
    let email: String
    let fullname: String
    let username: String
    let profileImageUrl: String
    
    init(uid:String, dictionary: [String: AnyObject]){
        self.uid = uid
        self.email = dictionary["email"] as? String ?? ""
        self.fullname = dictionary["fullname"] as? String ?? ""
        self.username = dictionary["username"] as? String ?? ""
        self.profileImageUrl = dictionary["profileImageUrl"] as? String ?? ""
    }
}
```

### User Instance

```swift
func fetchUser(){
    guard let uid = Auth.auth().currentUser?.uid else { return }
    
    REF_USERS.child(uid).observeSingleEvent(of: .value) { snapshot in
    
        guard let dictionary = snapshot.value as? [String: AnyObject] else { return }
        let user = User(uid: uid, dictionary: dictionary)
    }
}
```

# **24. SDWebImage Install & Passing User To FeedController**

<aside>
ğŸ’¡ **SDWebImage ëŒ€ì‹ ì— KingFisher ì‚¬ìš©í•´ë´„**

</aside>

### FeedController Navbar ì™¼ìª½ì— í”„ë¡œí•„ ë²„íŠ¼

```swift
let profileImageView = UIImageView().then {
    $0.backgroundColor = .twitterBlue
    $0.setDimensions(width: 32, height: 32)
    $0.layer.cornerRadius = 16
}
navigationItem.leftBarButtonItem = UIBarButtonItem(customView: profileImageView)
```

### MainTabController ì˜ ìœ ì €ì •ë³´ ë‹¤ë¥¸ ViewController ë¡œ ë„˜ê²¨ì£¼ê¸°

- ë˜í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬

```swift
struct UserService {
    static let shared = UserService()
    
    func fetchUser(completion: @escaping (User) -> Void){
        guard let uid = Auth.auth().currentUser?.uid else { return }
        
        REF_USERS.child(uid).observeSingleEvent(of: .value) { snapshot in
            guard let dictionary = snapshot.value as? [String: AnyObject] else { return }
                        let user = User(uid: uid, dictionary: dictionary)
            completion(user)
        }
    }
}
```

- **FeedVC ì°¾ì•„ì„œ ë‚ ë ¤ì£¼ê¸°**

```swift
// MainTabController
var user: User? {
    didSet{
        guard let nav = viewControllers?[0] as? UINavigationController else { return }
        guard let feedVC = nav.viewControllers.first as? FeedController else { return }
        feedVC.user = user
    }
}
```

# **25. Load User Profile Image**

### configureLeftBarButton()

```swift
// FeedController

func configureLeftBarButton() {
    guard let user = user else { return }
    
    let profileImageView = UIImageView().then {
        $0.backgroundColor = .twitterBlue
        $0.setDimensions(width: 32, height: 32)
        $0.layer.cornerRadius = 16
        $0.layer.masksToBounds = true
        $0.contentMode = .scaleAspectFill

        $0.kf.setImage(with: user.profileImageUrl)
    }
    navigationItem.leftBarButtonItem = UIBarButtonItem(customView: profileImageView)
}
```

### User Model ì•½ê°„ ë³€ê²½ : ëª¨ë¸ì—ì„œ URLë¡œ ë°”ê¿”ì¤Œ

```swift
struct User {
    var profileImageUrl: URL?
    
    init(uid:String, dictionary: [String: AnyObject]){
        
        if let profileImageUrl = dictionary["profileImageUrl"] as? String {
            guard let url = URL(string: profileImageUrl) else { return }
            self.profileImageUrl = url
        }
    }
}
```

### LifeCycle ViewDidLoad ë˜ê¸° ì´ì „ì— ì´ë¯¸ì§€ ì„¤ì •í•´ë²„ë¦¬ê¸°

```swift
// FeedController

var user: User? {
    didSet {
        configureLeftBarButton()
    }
}
```

d
