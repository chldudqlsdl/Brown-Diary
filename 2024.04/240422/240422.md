# **51. Search For Users**

<aside>
ğŸ’¡ **ì‚¬ìš©ì ê²€ìƒ‰ ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ ë³´ì : ë¶„ê¸°ì²˜ë¦¬ ì½”ë“œê°€ ë„ˆë¬´ ê¹”ë”í•˜ê³  ì¢‹ë‹¤!**

</aside>

### UISearchController ì„¸íŒ…

```swift
// ExploreController

private let searchController = UISearchController()

func configureSearchController() {
    searchController.searchResultsUpdater = self
    searchController.obscuresBackgroundDuringPresentation = false
    searchController.hidesNavigationBarDuringPresentation = false
    searchController.searchBar.placeholder = "Search for a user"
    navigationItem.searchController = searchController
    definesPresentationContext = true
}
```

### UISearchResultsUpdating Protocol + ë©‹ì§„ ë¡œì§

- **ì´ë¯¸ ë°›ì•˜ë˜ users ì—ì„œ ê²€ìƒ‰ì–´ë¥¼ ì´ìš©í•´ filter ê³ ì°¨í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ë²„ë¦°ë‹¤â€¦!**
- í•„í„°ë§ëœ ìœ ì €ë“¤ì„ ë‹´ì„ filteredUsers ë¦¬ìŠ¤íŠ¸

```swift
private var filteredUsers: [User] = [] {
    didSet { tableView.reloadData() }
}

extension ExploreController: UISearchResultsUpdating {
    func updateSearchResults(for searchController: UISearchController) {
        guard let searchText = searchController.searchBar.text?.lowercased() else { return }
        filteredUsers = users.filter({ $0.username.contains(searchText) })
    }
}
```

### ë¶„ê¸°ì²˜ë¦¬ + ë” ë©‹ì§„ ë¡œì§

- **ê²€ìƒ‰ì´ ì‹œì‘ë˜ì§€ ì•Šìœ¼ë©´ users , ê²€ìƒ‰ì´ ì‹œì‘ë˜ë©´ filteredUsers ë¡œ ë¶„ê¸°ì²˜ë¦¬ë¥¼ í•´ì¤€ë‹¤**

```swift
private var inSearchMode: Bool {
    return searchController.isActive && !searchController.searchBar.text!.isEmpty
}
```

- DataSource/ Delegate + í´ë¦­ì‹œ ProfileController ë¡œ push

```swift
extension ExploreController {
    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return inSearchMode ? filteredUsers.count : users.count
    }
    
    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeueReusableCell(withIdentifier: reuserIdentifier, for: indexPath) as! UserCell
        cell.user = inSearchMode ? filteredUsers[indexPath.row] : users[indexPath.row]
        return cell
    }
    
    override func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let user = inSearchMode ? filteredUsers[indexPath.row] : users[indexPath.row]
        let vc = ProfileController(user: user)
        navigationController?.pushViewController(vc, animated: true)
    }
}
```

# **52. Following User**

### CustomeDelegatePattern from ProfileHeader

```swift
protocol ProfileHeaderDelegate: AnyObject {
    func handleDismissal()
    func handleEditProfileFollow(_ header: ProfileHeader)
}

extension ProfileController: ProfileHeaderDelegate {
    func handleEditProfileFollow(_ header: ProfileHeader) {
        UserService.shared.followUser(uid: user.uid) { error, ref in
        }
    }
}
```

### UserService API call

- Follow ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
    - Following : ë‚˜ - ìƒëŒ€ë°©
    - Followers : ìƒëŒ€ë°© - ë‚˜
- updateChileValues ë¼ì„œ ì¤‘ë³µìœ¼ë¡œ ëˆŒëŸ¬ë„ ì¤‘ë³µ ì¶”ê°€ ì•ˆë˜ê³  ì—…ë°ì´íŠ¸ê°€ ë˜ëŠ” ë“¯

```swift
func followUser(uid: String, completion: @escaping (Error?, DatabaseReference) -> Void) {
    guard let currentUid = Auth.auth().currentUser?.uid else { return }
    
    REF_USER_FOLLOWING.child(currentUid).updateChildValues([uid: 1]) { error, ref in
        REF_USER_FOLLOWERS.child(uid).updateChildValues([currentUid: 1], withCompletionBlock: completion)
    }
}
```

# **53. Unfollow User**

<aside>
ğŸ’¡ **ì–¸íŒ”ë¡œìš° API ë§Œë“¤ê³ , íŒ”ë¡œìš° ë²„íŠ¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ íŒ”ë¡œìš° âˆ™ ì–¸íŒ”ë¡œìš° í† ê¸€**

</aside>

### typealias

- completion handler ì— ì“°ë©´ ë”±ì´êµ°

```swift
typealias DatabaseCompletion = (Error?, DatabaseReference) -> Void
```

### Unfollow API ë§Œë“¤ê¸°

```swift
func unFollowUser(uid: String, completion: @escaping DatabaseCompletion ) {
    guard let currentUid = Auth.auth().currentUser?.uid else { return }
    
    REF_USER_FOLLOWING.child(currentUid).child(uid).removeValue { error, ref in
        REF_USER_FOLLOWERS.child(uid).child(currentUid).removeValue(completionBlock: completion)
    }
}
```

### follow âˆ™ unfollow toggle

```swift
// User ëª¨ë¸ ìˆ˜ì • -> isFollowed ì¶”ê°€
struct User {
    let uid: String
    let email: String
    let fullname: String
    let username: String
    var profileImageUrl: URL?
    var isFollowed = false
} 

// ProfileController
extension ProfileController: ProfileHeaderDelegate {
    func handleEditProfileFollow(_ header: ProfileHeader) {
    
        if user.isFollowed {
            UserService.shared.unFollowUser(uid: user.uid) { err, ref in
                self.user.isFollowed = false
                self.collectionView.reloadData()
                print("ì–¸íŒ”ë¡œìš° ë˜ì—ˆìŠµë‹ˆë‹¤")
            }
        } else {
            UserService.shared.followUser(uid: user.uid) { eff, ref in
                self.user.isFollowed = true
                self.collectionView.reloadData()
                print("íŒ”ë¡œìš° ë˜ì—ˆìŠµë‹ˆë‹¤")
            }
        }
    }
}
```

# **54. Check If User Is Followed In Database**

<aside>
ğŸ’¡ **ìƒëŒ€ë°©ì— ëŒ€í•œ íŒ”ë¡œìš° ì—¬ë¶€ë¥¼ ì²´í¬í•´ì•¼ â†’ íŒ”ë¡œìš° ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ë°”ê¿”ì£¼ì§€**

</aside>

### checkIfUserIsFollowed

- **ì´ëŸ° ê¿€ ë©”ì„œë“œê°€? - `snapshot.exists()`**

```swift
// UserService

func checkIfUserIsFollowed(uid: String, completion: @escaping (Bool) -> Void) {
    guard let currentUid = Auth.auth().currentUser?.uid else { return }
    
    REF_USER_FOLLOWING.child(currentUid).child(uid).observeSingleEvent(of: .value) { snapshot in
        completion(snapshot.exists())
    }
}
```

- **íŒ”ë¡œìš°ë²„íŠ¼ì´ collectionViewHeader ì— ìˆê¸° ë•Œë¬¸ì— `reloadData()` ë¥¼ í•´ì¤˜ì•¼ í•œë‹¤!**

```swift
// ProfileController

func checkIfUserIsFollowed() {
    UserService.shared.checkIfUserIsFollowed(uid: user.uid) { isFollowed in
        self.user.isFollowed = isFollowed
        self.collectionView.reloadData()
    }
}
```

### ProfileHeaderViewModel - ë²„íŠ¼ í…ìŠ¤íŠ¸ ë°”ê¿”ì£¼ê¸°

- `reloadData()` í•  ë•Œë§ˆë‹¤ ì—…ë°ì´íŠ¸!

```swift
var followButtonTitle: String {
    if user.isCurrentUser {
        return "Edit Profile"
    } else {
        if !user.isFollowed {
            return "Follow"
        } else {
            return "Following"
        }
    }
}
```

# **56. Updating User Follower/Following Stats**

<aside>
ğŸ’¡ **User ëª¨ë¸ì— Stats ì¶”ê°€í•˜ê³ , ì„œë²„ì—ì„œ Followers âˆ™Following Stats ê°€ì ¸ì˜¤ì**

</aside>

### User Model ë³€ê²½ â†’ ìƒˆ êµ¬ì¡°ì²´ë¥¼ ë§Œë“œëŠ” ë°©ë²• ì—¬ëŸ¬ëª¨ë¡œ ì¢‹ì€ë“¯?

```swift
struct User {
    let uid: String
    let email: String
    let fullname: String
    let username: String
    var profileImageUrl: URL?
    var isFollowed = false
    var stats: UserRelationStats?
}

struct UserRelationStats {
    var followers: Int
    var following: Int
}
```

### UserService API

- `reloadData()` ê¹Œë¨¹ì§€ ë§ê¸°

```swift
// UserService
func fetchUserStats(uid: String, completion: @escaping (UserRelationStats) -> Void) {
    REF_USER_FOLLOWING.child(uid).observeSingleEvent(of: .value) { snapshot   in
        let following = snapshot.children.allObjects.count
        
        REF_USER_FOLLOWERS.child(uid).observeSingleEvent(of: .value) { snapshot  in
            let followers = snapshot.children.allObjects.count
            
            completion(UserRelationStats(followers: followers, following: following))
        }
    }
}

// ProfileController
func fetchUserStats() {
    UserService.shared.fetchUserStats(uid: user.uid) { stats in
        self.user.stats = stats
        self.collectionView.reloadData()
    }
}
```

- Follow ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ìŠ¤íƒ¯ ë³€ê²½ ë°˜ì˜

```swift
func handleEditProfileFollow(_ header: ProfileHeader) {
        fetchUserStats()
}
```

### ProfileHeaderViewModel

```swift
class ProfileHeaderViewModel {
    
    private let user: User
    
    var followersString: NSAttributedString? {
        return attributedText(withValue: user.stats?.followers ?? 0, text: "followers")
    }
    
    var followingString: NSAttributedString? {
        return attributedText(withValue: user.stats?.following ?? 0, text: "following")
    }
}
```

d
