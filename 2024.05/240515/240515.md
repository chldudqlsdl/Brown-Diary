# ViewController ì½”ë“œ êµ¬ë¶„

- NestedType
- Properties
- Lifecycle
- Attribute
- Layout
- Binding

# MainTabBarController ë¦¬íŒ©í„°ë§

### bind()

- ì—„ë°€íˆ í•˜ë©´ vc ì—ì„œ ê°’ì„ ë„˜ê¸°ì§€ ì•Šê³ ë„ vm ì—ì„œ `BehaviorSubject` ì‚¬ìš©í•˜ë©´ ê°€ëŠ¥í•œë°, ë‹¤ë¥¸ ì½”ë“œì—ì„œ`self.rx.viewWillAppear` ì‚¬ìš©í•˜ëŠ” ë¶„ìœ„ê¸°
    - vc ì—ì„œ Input ì„ ëª…í™•íˆ í™•ì¸í• ìˆ˜ ìˆëŠ” ì ì´ ì¢‹ì€ ë“¯

```swift
//MainTabBarController

func bind() {

    // ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­
    self.rx.viewWillAppear
        .map { _ in () }
        .bind(to: viewModel.checkLocationAuth)
        .disposed(by: disposeBag)
    
    // ì¢Œí‘œ ê°’ ìš”ì²­
    self.rx.viewWillAppear
        .map { _ in () }
        .bind(to: viewModel.fetchCoordinate)
        .disposed(by: disposeBag)
    
    // ì¢Œí‘œ ê°’ ì „ë‹¬
    viewModel.currentCoordinate
        .subscribe { [weak self] coordinate in
            self?.configureViewControllers(coordinate: coordinate)
        }
        .disposed(by: disposeBag)
}
```

# MainTabBarViewModel ë¦¬íŒ©í„°ë§

### PublicSubject

- ê¸°ì¡´ì—ëŠ” Inputì€ Observer , Outputì€ Observable ë¡œ êµ¬ë¶„í–ˆì—ˆëŠ”ë°, ì–´ì°¨í”¼ ì¤‘ê°„ì— ë‹¤ì‹œ Observer ë¥¼ Subjectë¡œ ë°”ê¿”ì•¼ í•´ì„œ ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì²˜ìŒë¶€í„° Subject ë¡œ ì‚¬ìš©
    - ì¼ë¶€ëŸ¬ ì €ë ‡ê²Œ ì“°ëŠ” ê¹Šì€ ëœ»ì€ ìˆê² ì§€ë§Œâ€¦

```swift
protocol MainTabBarViewModelType {
    var checkLocationAuth: PublishSubject<Void> { get }
    var fetchCoordinate: PublishSubject<Void> { get }
    
    var currentCoordinate: PublishSubject<CLLocationCoordinate2D> { get }
}
```

### flatMap

- checkLocation âˆ™fetchCoordinate ëª¨ë‘ viewWillAppear í•  ë•Œ  ë¹ˆ ê°’ì„ ë„˜ê²¨ì„œ subscriber ì—ê²Œ ì•Œë¦°ë‹¤ â†’ ê·¸ë¦¬ê³  ì´í›„ì—ëŠ” ì•„ë¬´ ê°’ë„ ë„˜ì–´ê°€ì§€ ì•ŠëŠ”ë‹¤
- í•˜ì§€ë§Œ `take(1)` ì´ ì—†ë‹¤ë©´, ìœ„ì¹˜ê°€ ë°”ë€” ë•Œ ë§ˆë‹¤ ê³„ì† ìƒˆ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì™€ í™”ë©´ì„ ì—…ë°ì´íŠ¸ í•¨ â†’ ë¯¸ìŠ¤í…Œë¦¬
- **ê·¸ê²Œ ë°”ë¡œ flatMap ì´ í•˜ëŠ” ì¼ â†’ ìœ„ì˜ ê·¸ë¦¼ ì°¸ì¡°**
    - **Observable ê³¼ ë³„ê°œë¡œ flatMap ë‚´ë¶€ì˜ Observable ì´ ê°’ì„ ë°©ì¶œí•˜ë©´ Subscriber ëŠ” ê·¸ ê°’ì„ ê³„ì† êµ¬ë…í•œë‹¤!**

```swift
init(){     
        checkLocationAuth
            .flatMap(LocationService.shared.requestLocation)
            .take(1)
            .bind { _ in }
            .disposed(by: disposeBag)
        
        fetchCoordinate
            .flatMap { LocationService.shared.locationSubject }
            .compactMap { $0 }
            .take(1)
            .bind(to: currentCoordinate)
            .disposed(by: disposeBag)
    }
```

# LocationService ë¦¬íŒ©í„°ë§

- requestWhenInUseAuthorization ë§Œ ì‘ë™ì‹œí‚¤ë©´ ë˜ì–´ì„œ
    - ì•„ë§ˆ ê¶Œí•œ ìŠ¹ì¸ì´ ë˜ë©´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ë¥¼ í•œë²ˆ í•˜ëŠ” ë“¯
- ë‚˜ë¨¸ì§€ëŠ” ì‚­ì œí•´ ì¤Œ
- defer ëŒ€ì‹  create ì„ ì¨ë„ ê°€ëŠ¥ì€ í•œ ë“¯?

```swift
func requestLocation() -> Observable<Void> {
    return Observable<Void>
        .deferred { [weak self] in
            guard let ls = self else { return .empty() }
            ls.locationManager.requestWhenInUseAuthorization()
            return Observable.just(())
    }
}

// ì´ ì½”ë“œë¥¼ ìœ„ ì½”ë“œë¡œ ì¤„ì„
func requestLocation() -> Observable<CLAuthorizationStatus> {
    return Observable<CLAuthorizationStatus>
        .deferred { [weak self] in
            guard let ss = self else { return .empty() }
            ss.locationManager.requestWhenInUseAuthorization()
            return ss.locationManager.rx.didChangeAuthorization
                .map { $1 }
                .filter { $0 != .notDetermined }
                .do(onNext: { _ in ss.locationManager.startUpdatingLocation() })
                .take(1)
        }
}
```

# CinemaViewController ë¦¬íŒ©í„°ë§

### forEach

- ì–˜ë„ ê³ ì°¨í•¨ìˆ˜ì¸ë° ì•ìœ¼ë¡œ ì• ìš©í•´ì•¼ê² ë‹¤

```swift
private func collectionViewAttribute() {
    let cvs = [cinemaCollectionView, dateCollectionView, movieCollectionView]
    cvs.forEach { cv in
        cv.backgroundColor = .systemBackground
        cv.isScrollEnabled = false
    }
    configureCellRegisterationAndDataSource()
}
```

# CinemaViewModel ë¦¬íŒ©í„°ë§

<aside>
ğŸ’¡ Observer âˆ™Observable ë‹¤ ì—†ì• ê³  Subject ë¡œ ë°”ê¿ˆ

</aside>

### compactMap ì˜ ì‚¬ë‘ìŠ¤ëŸ¬ì›€

- í˜„ì¬ ìœ„ì—ì„œ ë„˜ì–´ì˜¤ëŠ” ë¦¬í„´ ê°’ì´ ì˜µì…”ë„ íŠœí”Œì¸ë°, compactMapì€ ë‘ê°€ì§€ ì¼ì„ í•´ì¤€ë‹¤
    - nil ì„ ì—†ì• ì£¼ê³  + ì˜µì…”ë„ ë°”ì¸ë”© ê¹Œì§€

```swift
Observable
    .combineLatest(selectedCinema, selectedCinemaCalendar, didSelectDate) { cinema, calendar, dateIndex -> (IndieCinema, String)? in
        guard !calendar.businessDays.isEmpty else { return nil }
        return (cinema, calendar.businessDays[dateIndex])
    }
    .compactMap { $0 }
    .flatMap { cinemaAndDate in
        return CinemaService.shared.fetchCinemaSchedule(cinema: cinemaAndDate.0, date: cinemaAndDate.1)
    }
    .bind(to: selectedDateMovieSchedule)
    .disposed(by: disposeBag)
```

d
