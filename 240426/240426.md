# **75. Unliking Tweet**

### Unliking Logic

- cell.tweet ê°’ì„ ë°”ê¿”ì¤€ë‹¤

```swift
// TweetService
if tweet.didLike {
    REF_USER_LIKES.child(uid).child(tweet.tweetID).removeValue { err, ref in
        REF_TWEET_LIKES.child(tweet.tweetID).child(uid).removeValue(completionBlock: completion)
    }
}

// FeedController
func handleLikeTapped(_ cell: TweetCell) {
    guard let tweet = cell.tweet else { return }
    
    TweetService.shared.likeTweet(tweet: tweet) { err, ref in
        UIView.animate(withDuration: 0.5) {
            cell.tweet?.didLike.toggle()
        }
        let likes = tweet.didLike ? tweet.likes - 1 : tweet.likes + 1
        cell.tweet?.likes = likes
    }
}

```

### TweetViewModel - í•˜íŠ¸ ë„ìš°ê¸°

- TweetCell Viewì— Tweetì— didSet ì´ ìˆì–´ì„œ Tweet ì— ê°’ ë³€ê²½ì´ ì¼ì–´ë‚˜ë©´ ë·°ë¥¼ ìƒˆë¡œ ê·¸ë¦°ë‹¤!

```swift
var likeButtonTintColor: UIColor {
    return tweet.didLike ? .red : .darkGray
}

var likeButtonImage: UIImage {
    let imageName = tweet.didLike ? "like_filled" : "like"
    return UIImage(named: imageName)!
}
```

# **74. Liking A Tweet**

<aside>
ğŸ’¡ **API ìš”ì²­ : likes(likeCount) âˆ™ user-likes âˆ™ tweet-likes
í´ë¼ì´ì–¸íŠ¸ : cell.tweet ê°’ ë°”ê¿”ì£¼ê¸°**

</aside>

### TweetService

- likes(likeCount) âˆ™ user-likes âˆ™ tweet-likes ì…‹ ë‹¤ ë°”ê¿”ì£¼ê¸°

```swift
func likeTweet(tweet: Tweet, completion: @escaping DatabaseCompletion) {
    
    guard let uid = Auth.auth().currentUser?.uid else { return }
    
    let likes = tweet.didLike ? tweet.likes - 1 : tweet.likes + 1
    
    REF_TWEETS.child(tweet.tweetID).child("likes").setValue(likes)
    
    if tweet.didLike {
       
    } else {
        REF_USER_LIKES.child(uid).updateChildValues([tweet.tweetID : 1]) { err, ref in
            REF_TWEET_LIKES.child(tweet.tweetID).updateChildValues([uid : 1], withCompletionBlock: completion)
        }
    }
}
```

### FeedController

```swift
extension FeedController: TweetCellDelegate {
    
    func handleLikeTapped(_ cell: TweetCell) {
        guard let tweet = cell.tweet else { return }
        
        TweetService.shared.likeTweet(tweet: tweet) { err, ref in
            cell.tweet?.didLike.toggle()
            // ì•„ë˜ íŠ¸ìœ—ì€ ì´ë¯¸ ë°›ì•„ì™€ì„œ toggle ì˜ ì˜í–¥ì„ ì•ˆ ë°›ìŒ
            let likes = tweet.didLike ? tweet.likes - 1 : tweet.likes + 1
            cell.tweet?.likes = likes
        }
    }
}
```

# **77. Notification Data Model**

```swift
enum NotificationType: Int {
    case follow
    case like
    case reply
    case retweet
    case mention
}

struct Notification {
    let tweetID: String?
    var timestamp: Date!
    let user: User
    var tweet: Tweet?
    var type: NotificationType!
    
    init(user: User, tweet: Tweet?, dictionary: [String : AnyObject]) {
        self.user = user
        self.tweet = tweet
        self.tweetID = dictionary["tweetID"] as? String ?? ""
        
        if let timestamp = dictionary["timestamp"] as? Double {
            self.timestamp = Date(timeIntervalSince1970: timestamp)
        }
        
        if let typeNum = dictionary["type"] as? Int {
            self.type = NotificationType(rawValue: typeNum)
        }
    }
}
```

# **78. Upload Like Notification**

### NotificationService

- ìš°ì„  Tweetì— ì¢‹ì•„ìš” ëˆŒë €ì„ ë•Œ ì €ì¥ë˜ëŠ” Notification

```swift
struct NotificationService {
    
    func uploadNotification(type: NotificationType, tweet: Tweet? = nil) {
        guard let uid = Auth.auth().currentUser?.uid else { return }
        
        var values: [String: Any] = ["timestamp" : Int(NSDate().timeIntervalSince1970),
                                     "uid" : uid,
                                     "type" : type.rawValue]
        if let tweet = tweet {
            values["tweetID"] = tweet.tweetID
            REF_NOTIFICATIONS.child(tweet.uid).childByAutoId().updateChildValues(values)
        } else {
            
        }
    }
}
```

### FeedController

- Like Tapped ë˜ë©´ NotificationService í˜¸ì¶œ

```swift
func handleLikeTapped(_ cell: TweetCell, _ indexPath: IndexPath?) {
    
    TweetService.shared.likeTweet(tweet: tweet) { err, ref in
        UIView.animate(withDuration: 0.5) {
            cell.tweet?.didLike.toggle()
            self.tweets[indexPath.row].didLike.toggle()
        }
        let likes = tweet.didLike ? tweet.likes - 1 : tweet.likes + 1
        self.tweets[indexPath.row].likes = likes
        cell.tweet?.likes = likes
        
        // NotiUpload ëŠ” ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ì„ ë•Œë§Œ
        **if !tweet.didLike {
            NotificationService.shared.uploadNotification(type: .like, tweet: tweet)
        }**
    }
}
```

# **79. Upload Follow & Reply Notification**

### NotificationService

- íŠ¸ìœ— ì¢‹ì•„ìš” âˆ™ ëŒ“ê¸€ì€ íŒŒë¼ë¯¸í„°ì— tweet ì„ ë„£ì–´ì¤˜ì•¼ í•˜ê³ 
- íŒ”ë¡œìš°ëŠ” íŒŒë¼ë¯¸í„°ì— user ì„ ë„£ì–´ì¤€ë‹¤

```swift
func uploadNotification(type: NotificationType, tweet: Tweet? = nil, user: User? = nil) {
    guard let uid = Auth.auth().currentUser?.uid else { return }
    
    var values: [String: Any] = ["timestamp" : Int(NSDate().timeIntervalSince1970),
                                 "uid" : uid,
                                 "type" : type.rawValue]
    if let tweet = tweet {
        values["tweetID"] = tweet.tweetID
        REF_NOTIFICATIONS.child(tweet.uid).childByAutoId().updateChildValues(values)
    } else if let user = user {
        REF_NOTIFICATIONS.child(user.uid).childByAutoId().updateChildValues(values)
    }
}
```

### ì‹ ê¸°ìˆ  : ì´ëŸ°ê²Œ ìˆì—ˆì–´???

- ë¦¬í”Œ ì—…ë¡œë“œì¸ ê²½ìš°ì—ë§Œ ë…¸í‹° ì—…ë¡œë“œë¥¼ í•´ì•¼í•˜ë‹ˆê¹Œ
    - **`if case .reply(let tweet) = self.config`**
    - [ì—´ê±°í˜•ì— ì—°ê´€ê°’ì´ ìˆëŠ” ê²½ìš° (57ê°•)](https://www.notion.so/57-32e4f33496d0438a83f411fc2214b554?pvs=21) â†’ ì—¬ê¸°ì„œ í–ˆì—ˆêµ°

```swift
// UploadTweetController

@objc func handleUploadTweet() {
    guard let caption = captionTextView.text else { return }
    TweetService.shared.uploadTweet(caption: caption, type: config) { error, ref in
        if let error = error {
            print("DEBUG: Failed to upload tweet with \(error.localizedDescription)")
            return
        }
        **if case .reply(let tweet) = self.config {
            NotificationService.shared.uploadNotification(type: .reply, tweet: tweet)
        }**
   
        self.dismiss(animated: true, completion: nil)
    }
}
```

### ProfileController âˆ™TweetController ì—ì„œ íŒ”ë¡œìš° í•  ë•Œë„ ë…¸í‹° ì—…ë¡œë“œ ì‘ì„±í•´ì£¼ê¸°

d
